### Process ICGC BRCA data
## Yunlong Jiao, 10 March 2016

This script processes data and generates matrices for naive models later to make predictions.

```{r setup}
knitr::opts_chunk$set(error = FALSE)
set.seed(35875954)
source("../../src/func.R")
datapath <- '../../data/BRCA_saved_data/'
```

# Features

Feature matrices are provided by Marta stored at `crom01:/fsclinic/common/analisis/data/BRCA_saved_data`. Note that all feature matrices have to be initially provided by features in rows and patients in cols (to facilitate processing in a universal style). These matrix objects should have a name ending with `[.]vals$`.

```{r features}
# gene expression
load(paste0(datapath, '110_genes_vals.RData'))

# gene expression wrt those present in pathways
load(paste0(datapath, '110_mini_genes_vals.RData'))

# pathway-wise features
load(paste0(datapath, '110_hipathia_matrices.RData'))

xlist <- ls(pattern = '[.]vals$')
# show all feature matrices
xlist
for (xname in xlist) {
  # process each feature matrices
  x <- get(xname)
  # check no NA values
  stopifnot(!any(is.na(x)))
  # make patients in rows and features in cols
  x <- t(x)
  # check for no duplicated row- or col- names
  stopifnot(!any(duplicated(rownames(x))))
  stopifnot(!any(duplicated(colnames(x))))
  rownames(x) <- gsub('[^[:alnum:]_]', '_', rownames(x))
  colnames(x) <- gsub('[^[:alnum:]_]', '_', colnames(x))
  # assign back
  assign(xname, x)
  # preview
  cat('-------------> ', xname, ' <------------- \n')
  print(str(get(xname)))
  cat('\n')
}
# set samples
samplelist <- unique(lapply(xlist, function(xname) rownames(get(xname))))
stopifnot(length(samplelist) == 1)
samplelist <- unlist(samplelist)
nsample <- length(samplelist)
```

# Groups

Binary classes are created from clinical info for classification. There vector objects are named ending with `[.]grps$`.

```{r groups}
#### TODO
rbinom.grps <- factor(rbinom(nsample, 1, 0.5), labels = c('neg', 'pos'))
names(rbinom.grps) <- samplelist

ylist <- ls(pattern = '[.]grps$')
# show all label vectors
ylist
```

# Predictors

See `../../src/func.R` for all predictors implemented. These function objects should all have a name starting with `^predictor`.

```{r predictors}
prlist <- ls(pattern = '^predictor')
prlist
```

# Save up !!

```{r save}
# write out combinations of datasets for running on cluster
param <- expand.grid(xlist, ylist, prlist, KEEP.OUT.ATTRS = FALSE, stringsAsFactors = FALSE)
write.table(param, file = 'cluster_param.txt', quote = FALSE, row.names = TRUE, col.names = FALSE)

# save entire image to be loaded later
save(list = c(xlist, ylist), file = 'dat.RData')
```

# Session info

```{r session_info}
sessionInfo()
```
